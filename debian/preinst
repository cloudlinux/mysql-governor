#!/bin/bash
# preinst script for governor-mysql
#
# see: dh_installdeb(1)

set -e

. /usr/share/debconf/confmodule

db_get governor-mysql/g_key_library
gKEY="$RET"


# summary of how this script can be called:
#        * <new-preinst> `install'
#        * <new-preinst> `install' <old-version>
#        * <new-preinst> `upgrade' <old-version>
#        * <old-preinst> `abort-upgrade' <new-version>
# for details, see https://www.debian.org/doc/debian-policy/ or
# the debian-policy package


stop_mysql_service() {
    if [ -e /usr/lib/systemd/system/mysql.service -a -e /usr/bin/systemctl ]; then
        systemctl stop mysql.service || :
    elif [ -e /usr/lib/systemd/system/mysqld.service -a -e /usr/bin/systemctl ]; then
        systemctl stop mysqld.service || :
    elif [ -e /usr/lib/systemd/system/mariadb.service -a -e /usr/bin/systemctl ]; then
        systemctl stop mariadb.service || :
    elif [ -e /etc/init.d/mysql ]; then
        /etc/init.d/mysql stop || :
    elif [ -e /etc/init.d/mysqld ]; then
        /etc/init.d/mysqld stop || :
    fi
}

run_install_or_upgrade() {
    op="$1"

    if [ "$op" = "upgrade" ]; then
        service db_governor stop > /dev/null 2>&1 || :
        pkill db_governor || :
    fi

    mkdir -p /etc/container
    if [ "$op" = "install" ] ; then
        echo "$gKEY" > /etc/container/dbgovernor-libcheck
    elif [ "$op" = "upgrade" ]; then

        if [ -e "/etc/container/dbgovernor-libcheck" ]; then
            rKEY=`cat /etc/container/dbgovernor-libcheck | tr -d '\n'`
            if [ "$rKEY" != "$gKEY" ]; then
                echo "U" > /etc/container/dbgovernor-libcheck
                echo "Stop MySQL for safe installation"
                stop_mysql_service || :
            fi
        else
                echo "U" > /etc/container/dbgovernor-libcheck
                echo "Stop MySQL for safe installation"
                stop_mysql_service || :
        fi

    fi
}

case "$1" in
    install|upgrade)
        run_install_or_upgrade $1
    ;;

    abort-upgrade)
    ;;

    *)
        echo "preinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
